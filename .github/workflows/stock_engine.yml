name: Stock Engine (0830 + 1530 Full System)

on:
  schedule:
    # MORNING RUN — 08:30 IST = 03:00 UTC
    - cron: "0 3 * * *"

    # EOD RUN — 15:30 IST = 10:00 UTC
    - cron: "0 10 * * *"

  workflow_dispatch:   # Manual trigger

jobs:
  run-engine:
    runs-on: ubuntu-latest

    steps:

    # -----------------------------------------------------------
    # 1. Checkout repository
    # -----------------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # -----------------------------------------------------------
    # 2. Setup Python
    # -----------------------------------------------------------
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
        cache: "pip"

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install yfinance pandas numpy

    # -----------------------------------------------------------
    # 3. Determine Run Mode
    # -----------------------------------------------------------
    - name: Determine Run Mode
      id: runmode
      run: |
        # Convert current time to IST
        current_utc_hour=$(date -u +%H)
        current_utc_min=$(date -u +%M)

        # Convert to IST hour (UTC + 5:30)
        ist_hour=$(( (current_utc_hour + 5) % 24 ))
        ist_min=$(( (current_utc_min + 30) % 60 ))
        if [ "$current_utc_min" -ge 30 ]; then
          ist_hour=$(( (ist_hour + 1) % 24 ))
        fi

        echo "IST hour: $ist_hour"
        echo "IST minute: $ist_min"

        # -------------------------------------------------
        # Manual run logic:
        # If manually triggered, decide based on IST time
        # -------------------------------------------------
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          if [ "$ist_hour" -gt 15 ] || { [ "$ist_hour" -eq 15 ] && [ "$ist_min" -ge 30 ]; }; then
            echo "mode=1530" >> $GITHUB_OUTPUT
          else
            echo "mode=0830" >> $GITHUB_OUTPUT
          fi
          exit 0
        fi

        # -------------------------------------------------
        # Scheduled runs: Use UTC time directly
        # 03:00 UTC → MORNING
        # 10:00 UTC → EOD
        # -------------------------------------------------
        if [ "$current_utc_hour" = "03" ]; then
          echo "mode=0830" >> $GITHUB_OUTPUT
        else
          echo "mode=1530" >> $GITHUB_OUTPUT
        fi

    # -----------------------------------------------------------
    # 4. Run the stock engine script
    # -----------------------------------------------------------
    - name: Execute Stock Engine
      run: |
        export RUN_MODE=${{ steps.runmode.outputs.mode }}
        python stock_engine.py

    # -----------------------------------------------------------
    # 5. Commit and push generated CSVs
    # -----------------------------------------------------------
    - name: Commit & Push Outputs
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"

        git add output/*.csv
        git add output/archive/** || true

        git commit -m "Auto-update CSV files for ${{ steps.runmode.outputs.mode }}" || echo "No changes"

        git push || echo "No changes to push"
